<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SmartFarm Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #101820;
        font-family: Arial, sans-serif;
        color: #fff;
        padding: 20px;
      }
      .card {
        background: #1d2733;
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
      }
      h2 {
        margin-top: 0;
      }
      .sensor-box {
        font-size: 26px;
        margin: 8px 0;
      }
      .btn {
        padding: 10px 18px;
        font-size: 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        margin-right: 8px;
        margin-bottom: 6px;
      }
      .on {
        background: #2ecc71;
      }
      .off {
        background: #e74c3c;
      }
      .auto {
        background: #f1c40f;
        color: #000;
      }
    </style>
  </head>

  <body>
    <h1>ğŸŒ¿ SmartFarm Realtime Dashboard</h1>

    <div class="card">
      <h2>Thiáº¿t bá»‹</h2>
      <p><b>UID (MAC):</b> <span id="uid">C\98A316C019D4</span></p>
    </div>

    <div class="card">
      <h2>Cáº£m biáº¿n</h2>
      <div class="sensor-box">ğŸŒ¡ Nhiá»‡t Ä‘á»™: <span id="temp">--</span> Â°C</div>
      <div class="sensor-box">ğŸ’§ áº¨m khÃ´ng khÃ­: <span id="humi">--</span> %</div>
      <div class="sensor-box">ğŸ”† Ãnh sÃ¡ng: <span id="lux">--</span></div>
      <div class="sensor-box">ğŸŒ± Äá»™ áº©m Ä‘áº¥t: <span id="soil">--</span></div>
    </div>

    <div class="card">
      <h2>Tráº¡ng thÃ¡i hiá»‡n táº¡i</h2>
      <div class="sensor-box">ğŸ’¡ ÄÃ¨n: <span id="lightState">--</span></div>
      <div class="sensor-box">
        ğŸš° BÆ¡m nÆ°á»›c (mode): <span id="pumpMode">--</span>
      </div>
      <div class="sensor-box">ğŸ”” CÃ²i: <span id="buzzerState">--</span></div>
    </div>
    <div class="card">
      <h2>Cáº¥u hÃ¬nh Auto</h2>
      <p>
        NgÆ°á»¡ng áº©m Ä‘áº¥t Ä‘á»ƒ bÆ¡m báº­t (so sÃ¡nh vá»›i giÃ¡ trá»‹ <b>soil</b> ESP gá»­i lÃªn,
        Ä‘Æ¡n vá»‹ ADC 0â€“4095):
      </p>
      <input
        id="soilTh"
        type="number"
        min="0"
        max="4095"
        value="1500"
        style="padding: 8px; border-radius: 6px; border: none; width: 120px"
      />
      <button class="btn on" onclick="saveSoilTh()">LÆ°u ngÆ°á»¡ng</button>
    </div>
    <div class="card">
      <h2>CÃ i Ä‘áº·t Ä‘Ã¨n theo thá»i gian</h2>

      <p>GiÃ¢y báº­t:</p>
      <input id="onsec" type="number" min="0" max="9999" />

      <p>GiÃ¢y táº¯t:</p>
      <input id="offsec" type="number" min="0" max="9999" />

      <br /><br />
      <button class="btn on" onclick="saveCfg()">LÆ°u</button>
    </div>

    <div class="card">
      <h2>Äiá»u khiá»ƒn</h2>

      <p>ÄÃ¨n:</p>
      <button class="btn on" onclick="setAct('light',1)">Báº­t</button>
      <button class="btn off" onclick="setAct('light',0)">Táº¯t</button>
      <p>Cháº¿ Ä‘á»™:</p>
      <button class="btn on" onclick="setLightMode('manual')">MANUAL</button>
      <button class="btn off" onclick="setLightMode('auto')">AUTO</button>

      <p>Tráº¡ng thÃ¡i (chá»‰ MANUAL):</p>
      <button class="btn on" onclick="setAct('light',1)">Báº­t</button>
      <button class="btn off" onclick="setAct('light',0)">Táº¯t</button>
      <p>BÆ¡m nÆ°á»›c (state machine):</p>
      <button class="btn off" onclick="setAct('pump','off')">Táº¯t</button>
      <button class="btn on" onclick="setAct('pump','manual')">Báº­t tay</button>
      <button class="btn auto" onclick="setAct('pump','auto')">
        Auto theo Ä‘áº¥t
      </button>

      <p>CÃ²i bÃ¡o:</p>
      <button class="btn on" onclick="setAct('buzzer',1)">Báº­t</button>
      <button class="btn off" onclick="setAct('buzzer',0)">Táº¯t</button>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        child,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB3iSrRgGOms2TRwAxZbO1Cv7b6wrhldLA",
        authDomain: "smartfarms-27323.firebaseapp.com",
        databaseURL: "https://smartfarms-27323-default-rtdb.firebaseio.com",
        projectId: "smartfarms-27323",
        storageBucket: "smartfarms-27323.appspot.com",
        messagingSenderId: "320755880584",
        appId: "1:320755880584:web:21a95339088bc6a970c53d",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // UID MAC cá»‘ Ä‘á»‹nh
      const UID = "98A316C019D4";
      document.getElementById("uid").innerText = UID;
      const baseRef = ref(db, "devices/" + UID);

      //  SENSOR REALTIME
      onValue(child(baseRef, "sensors"), (snap) => {
        if (!snap.exists()) return;
        const v = snap.val();
        document.getElementById("temp").innerText = v.temp ?? "--";
        document.getElementById("humi").innerText = v.humi ?? "--";
        document.getElementById("lux").innerText = v.lux ?? "--";
        document.getElementById("soil").innerText = v.soil ?? "--";
      });

      //  ACTUATOR REALTIME
      onValue(child(baseRef, "actuators"), (snap) => {
        if (!snap.exists()) return;
        const a = snap.val();
        document.getElementById("lightState").innerText = a.light
          ? "Báº­t"
          : "Táº¯t";
        document.getElementById("buzzerState").innerText = a.buzzer
          ? "Báº­t"
          : "Táº¯t";
        document.getElementById("pumpMode").innerText = a.pump ?? "off";
      });

      // CONTROL
      function setAct(name, val) {
        update(child(baseRef, "actuators"), { [name]: val })
          .then(() => console.log("OK:", name, val))
          .catch((e) => console.error("ERR:", e));
      }
      function saveSoilTh() {
        const v = parseInt(document.getElementById("soilTh").value);
        if (isNaN(v)) {
          alert("Nháº­p sá»‘ há»£p lá»‡ 0â€“4095");
          return;
        }
        let val = v;
        if (val < 0) val = 0;
        if (val > 4095) val = 4095;

        update(child(baseRef, "config"), { soilThreshold: val })
          .then(() => {
            console.log("Saved soilThreshold =", val);
            alert("ÄÃ£ lÆ°u ngÆ°á»¡ng áº©m Ä‘áº¥t: " + val);
          })
          .catch((e) => {
            console.error(e);
            alert("Lá»—i khi lÆ°u ngÆ°á»¡ng!");
          });
      }
      function saveCfg() {
        let a = parseInt(document.getElementById("onsec").value);
        let b = parseInt(document.getElementById("offsec").value);

        update(child(baseRef, "config"), {
          light_on: a,
          light_off: b,
        })
          .then(() => alert("ÄÃ£ lÆ°u!"))
          .catch((e) => console.log("ERR", e));
      }

      window.saveSoilTh = saveSoilTh;
      window.setAct = setAct;
    </script>
  </body>
</html>
