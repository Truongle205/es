<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SmartFarm Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #101820;
        font-family: Arial, sans-serif;
        color: #fff;
        padding: 20px;
      }
      .card {
        background: #1d2733;
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 20px;
      }
      h2 {
        margin-top: 0;
      }
      .sensor-box {
        font-size: 26px;
        margin: 8px 0;
      }
      .btn {
        padding: 10px 18px;
        font-size: 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        margin-right: 8px;
        margin-bottom: 6px;
      }
      .on {
        background: #2ecc71;
      }
      .off {
        background: #e74c3c;
      }
      .auto {
        background: #f1c40f;
        color: #000;
      }
    </style>
  </head>

  <body>
    <h1>ğŸŒ¿ SmartFarm Realtime Dashboard</h1>

    <div class="card">
      <h2>Thiáº¿t bá»‹</h2>
      <p><b>UID (MAC):</b> <span id="uid">C\DCB4D91454A8</span></p>
    </div>

    <div class="card">
      <h2>Cáº£m biáº¿n</h2>
      <div class="sensor-box">ğŸŒ¡ Nhiá»‡t Ä‘á»™: <span id="temp">--</span> Â°C</div>
      <div class="sensor-box">ğŸ’§ áº¨m khÃ´ng khÃ­: <span id="humi">--</span> %</div>
      <div class="sensor-box">ğŸ”† Ãnh sÃ¡ng: <span id="lux">--</span></div>
      <div class="sensor-box">ğŸŒ± Äá»™ áº©m Ä‘áº¥t: <span id="soil">--</span></div>
    </div>

    <div class="card">
      <h2>Tráº¡ng thÃ¡i hiá»‡n táº¡i</h2>
      <div class="sensor-box">ğŸ’¡ ÄÃ¨n: <span id="lightState">--</span></div>
      <div class="sensor-box">
        ğŸš° BÆ¡m nÆ°á»›c (mode): <span id="pumpMode">--</span>
      </div>
      <div class="sensor-box">ğŸ”” CÃ²i: <span id="buzzerState">--</span></div>
    </div>

    <div class="card">
      <h2>Äiá»u khiá»ƒn</h2>

      <p>ÄÃ¨n:</p>
      <button class="btn on" onclick="setAct('light',1)">Báº­t</button>
      <button class="btn off" onclick="setAct('light',0)">Táº¯t</button>

      <p>BÆ¡m nÆ°á»›c (state machine):</p>
      <button class="btn off" onclick="setAct('pump','off')">Táº¯t</button>
      <button class="btn on" onclick="setAct('pump','manual')">Báº­t tay</button>
      <button class="btn auto" onclick="setAct('pump','auto')">
        Auto theo Ä‘áº¥t
      </button>

      <p>CÃ²i bÃ¡o:</p>
      <button class="btn on" onclick="setAct('buzzer',1)">Báº­t</button>
      <button class="btn off" onclick="setAct('buzzer',0)">Táº¯t</button>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        child,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB3iSrRgGOms2TRwAxZbO1Cv7b6wrhldLA",
        authDomain: "smartfarms-27323.firebaseapp.com",
        databaseURL: "https://smartfarms-27323-default-rtdb.firebaseio.com",
        projectId: "smartfarms-27323",
        storageBucket: "smartfarms-27323.appspot.com",
        messagingSenderId: "320755880584",
        appId: "1:320755880584:web:21a95339088bc6a970c53d",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // UID MAC cá»‘ Ä‘á»‹nh
      const UID = "DCB4D91454A8";
      document.getElementById("uid").innerText = UID;
      const baseRef = ref(db, "devices/" + UID);

      // ====== SENSOR REALTIME ======
      onValue(child(baseRef, "sensors"), (snap) => {
        if (!snap.exists()) return;
        const v = snap.val();
        document.getElementById("temp").innerText = v.temp ?? "--";
        document.getElementById("humi").innerText = v.humi ?? "--";
        document.getElementById("lux").innerText = v.lux ?? "--";
        document.getElementById("soil").innerText = v.soil ?? "--";
      });

      // ====== ACTUATOR REALTIME ======
      onValue(child(baseRef, "actuators"), (snap) => {
        if (!snap.exists()) return;
        const a = snap.val();
        document.getElementById("lightState").innerText = a.light
          ? "Báº­t"
          : "Táº¯t";
        document.getElementById("buzzerState").innerText = a.buzzer
          ? "Báº­t"
          : "Táº¯t";
        document.getElementById("pumpMode").innerText = a.pump ?? "off";
      });

      // ====== CONTROL ======
      function setAct(name, val) {
        update(child(baseRef, "actuators"), { [name]: val })
          .then(() => console.log("OK:", name, val))
          .catch((e) => console.error("ERR:", e));
      }
      window.setAct = setAct;
    </script>
  </body>
</html>
